<head>
    <title>Pi 5 Server</title>
</head>

<body>
    <h1>Robot Calibration</h1>
    <button id="calibrate-button" onclick="calibrateNext()">Start Calibration</button>
    
    <p id="radius-label">Radius: </p>
    <p id="distance-label">Estimated Distance: </p>
    <p id="factor-label">Factor: </p>
    
    <input id="factor-slider" type="range" min=1 max=5000 value=2440 /> 
    
    <span id="calibration">
        <h2 id="calibrate-label">Pl</h2>
        <button onclick="calibrateNext()">Next</button>
    </span>

    <button onclick="showPreview()">Show Preview</button>
    <img id="preview" src="" alt="Preview"/>

    <script type="text/javascript">
        var radius = 0;
        
        let radiusLabel = document.getElementById("radius-label");
        let distanceLabel = document.getElementById("distance-label");
        let factorLabel = document.getElementById("factor-label");
        
        let preview = document.getElementById("preview");
        let calibration = document.getElementById("calibration");
        let calibrateButton = document.getElementById("calibrate-button");
        let calibrateLabel = document.getElementById("calibrate-label");
        let factorSlider = document.getElementById("factor-slider");
        
        
        factor = 2440;
        factorLabel.innerHTML = `Factor: ${factor}`;
        factorSlider.addEventListener("input", () => {
            factor = factorSlider.value;
            factorLabel.innerHTML = `Factor: ${factor}`;
        });
        
        steps = [];
        step = 0;
        
        function calibrateNext() {
            if (step === 0) {
                calibrateButton.style.display = "none";
                calibration.style.display = "flex";
            } else
                steps.push(step + " " + radius);

            step += 10;
            
            if (step > 60) {
                console.log(steps.join("\n"));
                
                calibrateButton.style = "";
                calibration.style = "";
                calibrateLabel.innerHTML = "";
                steps = [];
                step = 0;
            } else
                calibrateLabel.innerHTML = `Place the ball ${step}cm away from the camera.`;
        }

        function showPreview() {
            fetch("/preview", {
                method: "POST",
                headers: {
                    "Content-type": "application/json; charset=UTF-8"
                }
                })
                .then(response => response.json())
                .then(data => {
                    preview.src = data.preview;
                })
                .catch(error => {return 0;});
        }

        function update() {
            fetch("/radius", {
                method: "POST",
                headers: {
                    "Content-type": "application/json; charset=UTF-8"
                }
                })
                .then(response => response.json())
                .then(data => {
                    radiusLabel.innerHTML = `Radius: ${data.radius}`;
                    radius = data.radius;
                    
                    distanceLabel.innerHTML = `Estimated Distance: ${factor / radius}`;
                })
                .catch(error => {return 0;});

            setTimeout("update();", 1000);
        }

        update();
    </script>
</body>
